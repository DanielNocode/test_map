<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Карта Идеальных Отношений — Схема квиза v2.0</title>
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --bg: #0d0d1a;
  --bg-board: #111122;
  --card-bg: #1a1a2e;
  --card-bg2: #1e1e36;
  --border: #2a2a4a;
  --text: #d0d0e8;
  --text-dim: #7777aa;
  --text-bright: #ffffff;
  --pink: #ff6b9d;
  --pink-bg: rgba(255,107,157,0.10);
  --blue: #6b9dff;
  --blue-bg: rgba(107,157,255,0.10);
  --purple: #a06bff;
  --purple-bg: rgba(160,107,255,0.10);
  --orange: #ffaa6b;
  --orange-bg: rgba(255,170,107,0.10);
  --green: #6bffb8;
  --green-bg: rgba(107,255,184,0.10);
  --yellow: #ffd76b;
  --yellow-bg: rgba(255,215,107,0.10);
}

body {
  font-family: 'Inter', system-ui, -apple-system, sans-serif;
  background: var(--bg);
  color: var(--text);
  line-height: 1.5;
  overflow: hidden;
  height: 100vh;
  user-select: text;
}

/* ===== TOOLBAR ===== */
.toolbar {
  position: fixed;
  top: 0; left: 0; right: 0;
  height: 44px;
  background: rgba(13,13,26,0.95);
  backdrop-filter: blur(10px);
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  padding: 0 16px;
  z-index: 1000;
  gap: 12px;
}
.toolbar-title { font-size: 14px; font-weight: 700; color: var(--text-bright); white-space: nowrap; }
.toolbar-sub { font-size: 11px; color: var(--text-dim); }
.toolbar-sep { width: 1px; height: 20px; background: var(--border); }
.toolbar-nav { display: flex; gap: 3px; flex-wrap: nowrap; overflow-x: auto; }
.chip { padding: 3px 10px; border-radius: 10px; font-size: 11px; cursor: pointer; border: 1px solid transparent; color: var(--text-dim); transition: 0.2s; white-space: nowrap; }
.chip:hover { color: var(--text-bright); background: rgba(255,255,255,0.06); }
.chip-pink { border-color: rgba(255,107,157,0.3); color: var(--pink); }
.chip-blue { border-color: rgba(107,157,255,0.3); color: var(--blue); }
.chip-purple { border-color: rgba(160,107,255,0.3); color: var(--purple); }
.chip-orange { border-color: rgba(255,170,107,0.3); color: var(--orange); }
.chip-green { border-color: rgba(107,255,184,0.3); color: var(--green); }
.zoom-controls { display: flex; align-items: center; gap: 5px; margin-left: auto; }
.zoom-controls span { font-size: 11px; color: var(--text-dim); min-width: 36px; text-align: center; }
.tbtn { padding: 3px 10px; background: rgba(255,255,255,0.05); border: 1px solid var(--border); border-radius: 5px; color: var(--text); font-size: 12px; cursor: pointer; }
.tbtn:hover { background: rgba(255,255,255,0.1); }

/* ===== CANVAS ===== */
.canvas-wrap {
  position: fixed;
  top: 44px; left: 0; right: 0; bottom: 0;
  overflow: hidden;
  cursor: grab;
  background: var(--bg-board);
}
.canvas-wrap.panning { cursor: grabbing; }
.canvas-grid {
  position: absolute; inset: 0;
  background-image: radial-gradient(circle, rgba(255,255,255,0.025) 1px, transparent 1px);
  background-size: 28px 28px;
  pointer-events: none;
}
.canvas {
  position: absolute;
  transform-origin: 0 0;
  will-change: transform;
}

/* ===== SVG ===== */
.arrows-svg {
  position: absolute; top: 0; left: 0;
  pointer-events: none; overflow: visible;
}

/* ===== QUESTION CARD ===== */
.qcard {
  position: absolute;
  width: 340px;
  background: var(--card-bg);
  border: 1.5px solid var(--border);
  border-radius: 14px;
  overflow: hidden;
  box-shadow: 0 4px 24px rgba(0,0,0,0.5);
  transition: box-shadow 0.2s;
}
.qcard:hover { box-shadow: 0 8px 32px rgba(0,0,0,0.7); }

.qcard-head {
  padding: 12px 16px;
  display: flex;
  align-items: center;
  gap: 10px;
  border-bottom: 1px solid var(--border);
}
.qcard-num {
  padding: 3px 10px;
  border-radius: 6px;
  font-size: 12px;
  font-weight: 800;
  flex-shrink: 0;
}
.qcard-title {
  font-size: 13px;
  font-weight: 600;
  color: var(--text-bright);
  flex: 1;
}
.qcard-var {
  font-family: 'JetBrains Mono', 'Fira Code', monospace;
  font-size: 11px;
  padding: 2px 8px;
  border-radius: 4px;
  background: var(--green-bg);
  color: var(--green);
}

.qcard-msg {
  padding: 10px 16px;
  font-size: 12px;
  color: var(--text-dim);
  border-bottom: 1px solid rgba(255,255,255,0.03);
  white-space: pre-line;
  line-height: 1.6;
}

.qcard-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 11px;
}
.qcard-table th {
  text-align: left;
  padding: 6px 12px;
  background: rgba(255,255,255,0.02);
  color: var(--text-dim);
  font-weight: 600;
  font-size: 10px;
  text-transform: uppercase;
  letter-spacing: 0.3px;
}
.qcard-table td {
  padding: 5px 12px;
  border-top: 1px solid rgba(255,255,255,0.025);
}
.qcard-table tr:hover td { background: rgba(255,255,255,0.015); }
.v { color: var(--green); font-family: monospace; font-size: 11px; }
.p { color: var(--yellow); font-weight: 700; }
.b { display: inline-block; padding: 1px 8px; background: var(--purple-bg); border-radius: 4px; color: var(--purple); font-weight: 700; font-size: 11px; }

.qcard-next {
  padding: 8px 16px;
  font-size: 11px;
  border-top: 1px solid rgba(255,255,255,0.03);
  color: var(--text-dim);
}
.qcard-next strong { color: var(--purple); }
.next-pink { color: var(--pink); }
.next-blue { color: var(--blue); }

/* Card border colors */
.qcard-purple { border-color: rgba(160,107,255,0.4); }
.qcard-purple .qcard-head { background: var(--purple-bg); }
.qcard-purple .qcard-num { background: var(--purple-bg); color: var(--purple); }

.qcard-pink { border-color: rgba(255,107,157,0.4); }
.qcard-pink .qcard-head { background: var(--pink-bg); }
.qcard-pink .qcard-num { background: var(--pink-bg); color: var(--pink); }

.qcard-blue { border-color: rgba(107,157,255,0.4); }
.qcard-blue .qcard-head { background: var(--blue-bg); }
.qcard-blue .qcard-num { background: var(--blue-bg); color: var(--blue); }

.qcard-orange { border-color: rgba(255,170,107,0.4); }
.qcard-orange .qcard-head { background: var(--orange-bg); }
.qcard-orange .qcard-num { background: var(--orange-bg); color: var(--orange); }

.qcard-green { border-color: rgba(107,255,184,0.4); }
.qcard-green .qcard-head { background: var(--green-bg); }
.qcard-green .qcard-num { background: var(--green-bg); color: var(--green); }

/* ===== GROUP LABEL ===== */
.group-label {
  position: absolute;
  font-size: 18px;
  font-weight: 800;
  letter-spacing: 1px;
  opacity: 0.15;
  pointer-events: none;
  text-transform: uppercase;
}

/* ===== BRANCH LABEL ===== */
.branch-tag {
  position: absolute;
  padding: 4px 14px;
  border-radius: 12px;
  font-size: 12px;
  font-weight: 700;
}

/* ===== DECISION NODE ===== */
.decision {
  position: absolute;
  background: var(--card-bg);
  border: 2px dashed var(--purple);
  border-radius: 14px;
  padding: 14px 24px;
  text-align: center;
  box-shadow: 0 4px 20px rgba(0,0,0,0.4);
}
.decision-label { font-size: 14px; font-weight: 700; color: var(--text-bright); }
.decision-sub { font-size: 11px; color: var(--text-dim); margin-top: 2px; }

/* ===== LEGEND ===== */
.legend {
  position: fixed; bottom: 12px; left: 12px;
  background: rgba(13,13,26,0.92); backdrop-filter: blur(8px);
  border: 1px solid var(--border); border-radius: 10px;
  padding: 10px 14px; z-index: 500; font-size: 11px;
}
.legend-row { display: flex; align-items: center; gap: 7px; margin-bottom: 3px; }
.legend-row:last-child { margin-bottom: 0; }
.legend-dot { width: 10px; height: 10px; border-radius: 3px; }

/* ===== MINIMAP ===== */
.minimap {
  position: fixed; bottom: 12px; right: 12px;
  width: 180px; height: 120px;
  background: rgba(13,13,26,0.92); backdrop-filter: blur(8px);
  border: 1px solid var(--border); border-radius: 10px;
  overflow: hidden; z-index: 500;
}
.minimap canvas { width: 100%; height: 100%; }
.minimap-vp { position: absolute; border: 1.5px solid var(--purple); background: rgba(160,107,255,0.06); border-radius: 2px; pointer-events: none; }

/* ===== PLACEHOLDER ===== */
.placeholder-card {
  position: absolute;
  width: 340px;
  background: var(--card-bg);
  border: 1.5px dashed var(--border);
  border-radius: 14px;
  padding: 30px 20px;
  text-align: center;
  color: var(--text-dim);
  font-size: 13px;
  font-style: italic;
  opacity: 0.6;
}
</style>
</head>
<body>

<!-- TOOLBAR -->
<div class="toolbar">
  <div class="toolbar-title">Карта Идеальных Отношений</div>
  <div class="toolbar-sub">v2.0</div>
  <div class="toolbar-sep"></div>
  <div class="toolbar-nav">
    <div class="chip chip-purple" onclick="jumpTo(880,60)">Блок 1</div>
    <div class="chip chip-pink" onclick="jumpTo(200,1200)">2А</div>
    <div class="chip chip-blue" onclick="jumpTo(1400,1200)">2Б</div>
    <div class="chip chip-orange" onclick="jumpTo(600,2500)">Блок 3</div>
    <div class="chip chip-pink" onclick="jumpTo(200,3500)">4А</div>
    <div class="chip chip-blue" onclick="jumpTo(1400,3500)">4Б</div>
    <div class="chip chip-pink" onclick="jumpTo(200,4200)">Блок 5</div>
    <div class="chip chip-green" onclick="jumpTo(800,5300)">Результат</div>
  </div>
  <div class="zoom-controls">
    <button class="tbtn" onclick="zoomBy(-0.1)">-</button>
    <span id="zoomLvl">45%</span>
    <button class="tbtn" onclick="zoomBy(0.1)">+</button>
    <button class="tbtn" onclick="resetView()">Fit</button>
  </div>
</div>

<!-- CANVAS -->
<div class="canvas-wrap" id="wrap">
  <div class="canvas-grid"></div>
  <div class="canvas" id="canvas">

    <!-- SVG arrows -->
    <svg class="arrows-svg" id="svg" width="2600" height="7000">
      <defs>
        <marker id="ap" markerWidth="8" markerHeight="6" refX="7" refY="3" orient="auto"><polygon points="0 0,8 3,0 6" fill="#a06bff"/></marker>
        <marker id="ak" markerWidth="8" markerHeight="6" refX="7" refY="3" orient="auto"><polygon points="0 0,8 3,0 6" fill="#ff6b9d"/></marker>
        <marker id="ab" markerWidth="8" markerHeight="6" refX="7" refY="3" orient="auto"><polygon points="0 0,8 3,0 6" fill="#6b9dff"/></marker>
        <marker id="ao" markerWidth="8" markerHeight="6" refX="7" refY="3" orient="auto"><polygon points="0 0,8 3,0 6" fill="#ffaa6b"/></marker>
        <marker id="ag" markerWidth="8" markerHeight="6" refX="7" refY="3" orient="auto"><polygon points="0 0,8 3,0 6" fill="#6bffb8"/></marker>
      </defs>
    </svg>

    <!-- ========== BLOCK 1: BASE STATUS ========== -->
    <div class="group-label" style="left:780px; top:20px; color:var(--purple);">Блок 1: Базовый Статус</div>

    <!-- Q 1.1 -->
    <div class="qcard qcard-purple" id="q11" style="left:880px; top:60px;">
      <div class="qcard-head">
        <span class="qcard-num">1.1</span>
        <span class="qcard-title">Сейчас ты...</span>
        <span class="qcard-var">{status}</span>
      </div>
      <div class="qcard-msg">Карта Идеальных Отношений
Начнём с главного. Сейчас ты...</div>
      <table class="qcard-table">
        <tr><th>Кнопка</th><th>Значение</th><th>Далее</th></tr>
        <tr><td><span class="b">1</span> Свободна</td><td class="v">free</td><td>-> 1.1б</td></tr>
        <tr><td><span class="b">2</span> В отношениях</td><td class="v">together</td><td>-> 1.2</td></tr>
        <tr><td><span class="b">3</span> Замужем</td><td class="v">married</td><td>-> 1.2</td></tr>
      </table>
    </div>

    <!-- branch labels -->
    <div class="branch-tag" style="left:620px; top:295px; background:var(--blue-bg); color:var(--blue);">status = free</div>
    <div class="branch-tag" style="left:1350px; top:295px; background:var(--pink-bg); color:var(--pink);">status != free</div>

    <!-- Q 1.1б -->
    <div class="qcard qcard-purple" id="q11b" style="left:440px; top:340px;">
      <div class="qcard-head">
        <span class="qcard-num">1.1б</span>
        <span class="qcard-title">Почему сейчас одна?</span>
        <span class="qcard-var">{why_single}</span>
      </div>
      <div class="qcard-msg">Только если status = free
Авто: {years} = none</div>
      <table class="qcard-table">
        <tr><th>Кнопка</th><th>Значение</th></tr>
        <tr><td><span class="b">1</span> Не отошла от прошлых</td><td class="v">past_hurt</td></tr>
        <tr><td><span class="b">2</span> Не могу найти нормальных</td><td class="v">no_good_men</td></tr>
        <tr><td><span class="b">3</span> Нет времени</td><td class="v">no_time</td></tr>
        <tr><td><span class="b">4</span> Сама так решила</td><td class="v">by_choice</td></tr>
        <tr><td><span class="b">5</span> Так сложилось</td><td class="v">just_happened</td></tr>
      </table>
      <div class="qcard-next">-> <strong>Вопрос 1.3</strong></div>
    </div>

    <!-- Q 1.2 -->
    <div class="qcard qcard-purple" id="q12" style="left:1300px; top:340px;">
      <div class="qcard-head">
        <span class="qcard-num">1.2</span>
        <span class="qcard-title">Сколько вы вместе?</span>
        <span class="qcard-var">{years}</span>
      </div>
      <div class="qcard-msg">Только если status != free</div>
      <table class="qcard-table">
        <tr><th>Кнопка</th><th>Значение</th></tr>
        <tr><td><span class="b">1</span> До 1 года</td><td class="v">under1</td></tr>
        <tr><td><span class="b">2</span> 1-3 года</td><td class="v">1to3</td></tr>
        <tr><td><span class="b">3</span> 3-7 лет</td><td class="v">3to7</td></tr>
        <tr><td><span class="b">4</span> 7-15 лет</td><td class="v">7to15</td></tr>
        <tr><td><span class="b">5</span> Больше 15 лет</td><td class="v">over15</td></tr>
      </table>
      <div class="qcard-next">-> <strong>Вопрос 1.3</strong></div>
    </div>

    <!-- Q 1.3 -->
    <div class="qcard qcard-purple" id="q13" style="left:880px; top:760px;">
      <div class="qcard-head">
        <span class="qcard-num">1.3</span>
        <span class="qcard-title">Дети?</span>
        <span class="qcard-var">{kids}</span>
      </div>
      <table class="qcard-table">
        <tr><th>Кнопка</th><th>Значение</th></tr>
        <tr><td><span class="b">1</span> Нет детей</td><td class="v">no</td></tr>
        <tr><td><span class="b">2</span> Маленькие (до 7)</td><td class="v">small</td></tr>
        <tr><td><span class="b">3</span> Школьники/подростки</td><td class="v">teen</td></tr>
        <tr><td><span class="b">4</span> Уже взрослые</td><td class="v">adult</td></tr>
      </table>
      <div class="qcard-next">
        <span class="next-pink">status != free -> Блок 2А</span> &middot;
        <span class="next-blue">status = free -> Блок 2Б</span>
      </div>
    </div>

    <!-- ========== DECISION ========== -->
    <div class="decision" id="dec1" style="left:920px; top:1040px;">
      <div class="decision-label">Развилка по {status}</div>
      <div class="decision-sub">free -> 2Б &middot; together/married -> 2А</div>
    </div>


    <!-- ============================================================ -->
    <!-- ========== BLOCK 2A: IN COUPLE (3 questions) =============== -->
    <!-- ============================================================ -->
    <div class="group-label" style="left:60px; top:1130px; color:var(--pink);">Блок 2А: В Паре (status != free)</div>

    <!-- Q 2A.1 -->
    <div class="qcard qcard-pink" id="q2a1" style="left:100px; top:1180px;">
      <div class="qcard-head">
        <span class="qcard-num">2А.1</span>
        <span class="qcard-title">В близости комфортнее...</span>
        <span class="qcard-var">{her_role}</span>
      </div>
      <div class="qcard-msg">В близости тебе комфортнее, когда...</div>
      <table class="qcard-table">
        <tr><th>Кнопка</th><th>Значение</th></tr>
        <tr><td><span class="b">1</span> Он ведёт, я отдаюсь</td><td class="v">receiver</td></tr>
        <tr><td><span class="b">2</span> Я веду, он в моих руках</td><td class="v">giver</td></tr>
        <tr><td><span class="b">3</span> Мы на равных</td><td class="v">equal</td></tr>
        <tr><td><span class="b">4</span> Зависит от настроения</td><td class="v">flexible</td></tr>
      </table>
      <div class="qcard-next">-> <strong>2А.2</strong></div>
    </div>

    <!-- Q 2A.2 -->
    <div class="qcard qcard-pink" id="q2a2" style="left:100px; top:1530px;">
      <div class="qcard-head">
        <span class="qcard-num">2А.2</span>
        <span class="qcard-title">Прокачать одно — что?</span>
        <span class="qcard-var">{her_goal}</span>
      </div>
      <div class="qcard-msg">Если бы можно было прокачать одно — что бы выбрала?</div>
      <table class="qcard-table">
        <tr><th>Кнопка</th><th>Значение</th></tr>
        <tr><td><span class="b">1</span> Чувствовать себя желанной</td><td class="v">confidence</td></tr>
        <tr><td><span class="b">2</span> Доставлять ему незабываемое</td><td class="v">skills</td></tr>
        <tr><td><span class="b">3</span> Получать больше удовольствия</td><td class="v">pleasure</td></tr>
        <tr><td><span class="b">4</span> Добавить экспериментов</td><td class="v">experiments</td></tr>
      </table>
      <div class="qcard-next">-> <strong>2А.3</strong></div>
    </div>

    <!-- Q 2A.3 -->
    <div class="qcard qcard-pink" id="q2a3" style="left:100px; top:1880px;">
      <div class="qcard-head">
        <span class="qcard-num">2А.3</span>
        <span class="qcard-title">Что уже есть?</span>
        <span class="qcard-var">{her_experience}</span>
      </div>
      <div class="qcard-msg">Что из этого уже есть в твоей жизни? (выбери главное)</div>
      <table class="qcard-table">
        <tr><th>Кнопка</th><th>Значение</th></tr>
        <tr><td><span class="b">1</span> Оральные ласки — моя сила</td><td class="v">oral</td></tr>
        <tr><td><span class="b">2</span> Экспериментирую с позами</td><td class="v">poses</td></tr>
        <tr><td><span class="b">3</span> Использую игрушки</td><td class="v">toys</td></tr>
        <tr><td><span class="b">4</span> Пробовала ролевые</td><td class="v">roleplay</td></tr>
        <tr><td><span class="b">5</span> Базовый опыт, хочу большего</td><td class="v">basic</td></tr>
      </table>
      <div class="qcard-next">-> <strong>Блок 3</strong> (вопрос 3.1)</div>
    </div>


    <!-- ============================================================ -->
    <!-- ========== BLOCK 2B: SINGLE (6 questions) ================== -->
    <!-- ============================================================ -->
    <div class="group-label" style="left:1350px; top:1130px; color:var(--blue);">Блок 2Б: Свободна (status = free)</div>

    <!-- Q 2Б.1 -->
    <div class="qcard qcard-blue" id="q2b1" style="left:1400px; top:1180px;">
      <div class="qcard-head">
        <span class="qcard-num">2Б.1</span>
        <span class="qcard-title">Когда последний секс?</span>
        <span class="qcard-var">{last_sex}</span>
      </div>
      <div class="qcard-msg">Когда у тебя был секс последний раз?</div>
      <table class="qcard-table">
        <tr><th>Кнопка</th><th>Значение</th><th class="p">Баллы</th></tr>
        <tr><td><span class="b">1</span> На этой неделе</td><td class="v">this_week</td><td class="p">5</td></tr>
        <tr><td><span class="b">2</span> В этом месяце</td><td class="v">this_month</td><td class="p">4</td></tr>
        <tr><td><span class="b">3</span> Несколько месяцев назад</td><td class="v">few_months</td><td class="p">3</td></tr>
        <tr><td><span class="b">4</span> Полгода-год назад</td><td class="v">half_year</td><td class="p">2</td></tr>
        <tr><td><span class="b">5</span> Больше года</td><td class="v">over_year</td><td class="p">1</td></tr>
      </table>
      <div class="qcard-next">-> <strong>2Б.2</strong></div>
    </div>

    <!-- Q 2Б.2 -->
    <div class="qcard qcard-blue" id="q2b2" style="left:1400px; top:1530px;">
      <div class="qcard-head">
        <span class="qcard-num">2Б.2</span>
        <span class="qcard-title">Тебя зовут на свидания?</span>
        <span class="qcard-var">{dates_invites}</span>
      </div>
      <table class="qcard-table">
        <tr><th>Кнопка</th><th>Значение</th><th class="p">Баллы</th></tr>
        <tr><td><span class="b">1</span> Регулярно, отбоя нет</td><td class="v">often</td><td class="p">5</td></tr>
        <tr><td><span class="b">2</span> Иногда приглашают</td><td class="v">sometimes</td><td class="p">4</td></tr>
        <tr><td><span class="b">3</span> Редко, но бывает</td><td class="v">rare</td><td class="p">3</td></tr>
        <tr><td><span class="b">4</span> Почти никогда</td><td class="v">almost_never</td><td class="p">2</td></tr>
        <tr><td><span class="b">5</span> Сама не даю повода</td><td class="v">no_signals</td><td class="p">1</td></tr>
      </table>
      <div class="qcard-next">-> <strong>2Б.3</strong></div>
    </div>

    <!-- Q 2Б.3 -->
    <div class="qcard qcard-blue" id="q2b3" style="left:1400px; top:1880px;">
      <div class="qcard-head">
        <span class="qcard-num">2Б.3</span>
        <span class="qcard-title">Приложения для знакомств?</span>
        <span class="qcard-var">{dating_apps}</span>
      </div>
      <div class="qcard-msg">Пользуешься приложениями для знакомств?</div>
      <table class="qcard-table">
        <tr><th>Кнопка</th><th>Значение</th><th class="p">Баллы</th></tr>
        <tr><td><span class="b">1</span> Да, активно свайпаю</td><td class="v">active</td><td class="p">5</td></tr>
        <tr><td><span class="b">2</span> Есть профиль, иногда</td><td class="v">passive</td><td class="p">3</td></tr>
        <tr><td><span class="b">3</span> Пробовала, удалила</td><td class="v">tried_quit</td><td class="p">2</td></tr>
        <tr><td><span class="b">4</span> Нет, принципиально</td><td class="v">no_principle</td><td class="p">1</td></tr>
        <tr><td><span class="b">5</span> Думаю попробовать</td><td class="v">thinking</td><td class="p">2</td></tr>
      </table>
      <div class="qcard-next">-> <strong>2Б.4</strong></div>
    </div>

    <!-- Q 2Б.4 -->
    <div class="qcard qcard-blue" id="q2b4" style="left:1820px; top:1180px;">
      <div class="qcard-head">
        <span class="qcard-num">2Б.4</span>
        <span class="qcard-title">Умеешь флиртовать?</span>
        <span class="qcard-var">{flirt_skill}</span>
      </div>
      <table class="qcard-table">
        <tr><th>Кнопка</th><th>Значение</th><th class="p">Баллы</th></tr>
        <tr><td><span class="b">1</span> Мой конёк, мужчины тают</td><td class="v">expert</td><td class="p">5</td></tr>
        <tr><td><span class="b">2</span> Умею, когда нравится</td><td class="v">good</td><td class="p">4</td></tr>
        <tr><td><span class="b">3</span> Пытаюсь, не уверена</td><td class="v">trying</td><td class="p">3</td></tr>
        <tr><td><span class="b">4</span> Стесняюсь</td><td class="v">shy</td><td class="p">2</td></tr>
        <tr><td><span class="b">5</span> Жду когда сами подойдут</td><td class="v">passive</td><td class="p">1</td></tr>
      </table>
      <div class="qcard-next">-> <strong>2Б.5</strong></div>
    </div>

    <!-- Q 2Б.5 -->
    <div class="qcard qcard-blue" id="q2b5" style="left:1820px; top:1530px;">
      <div class="qcard-head">
        <span class="qcard-num">2Б.5</span>
        <span class="qcard-title">На первом свидании?</span>
        <span class="qcard-var">{first_date_feel}</span>
      </div>
      <div class="qcard-msg">Как ты себя ощущаешь на первом свидании?</div>
      <table class="qcard-table">
        <tr><th>Кнопка</th><th>Значение</th><th class="p">Баллы</th></tr>
        <tr><td><span class="b">1</span> Как королева</td><td class="v">confident</td><td class="p">5</td></tr>
        <tr><td><span class="b">2</span> Нормально, чуть волнуюсь</td><td class="v">normal</td><td class="p">4</td></tr>
        <tr><td><span class="b">3</span> Напрягаюсь</td><td class="v">tense</td><td class="p">2</td></tr>
        <tr><td><span class="b">4</span> Сильно нервничаю</td><td class="v">anxious</td><td class="p">1</td></tr>
        <tr><td><span class="b">5</span> Давно не была, не помню</td><td class="v">forgot</td><td class="p">2</td></tr>
      </table>
      <div class="qcard-next">-> <strong>2Б.6</strong></div>
    </div>

    <!-- Q 2Б.6 -->
    <div class="qcard qcard-blue" id="q2b6" style="left:1820px; top:1880px;">
      <div class="qcard-head">
        <span class="qcard-num">2Б.6</span>
        <span class="qcard-title">Прокачать одно — что?</span>
        <span class="qcard-var">{her_goal_single}</span>
      </div>
      <div class="qcard-msg">Если бы можно было прокачать одно — что бы выбрала?</div>
      <table class="qcard-table">
        <tr><th>Кнопка</th><th>Значение</th></tr>
        <tr><td><span class="b">1</span> Привлекать достойных мужчин</td><td class="v">attract</td></tr>
        <tr><td><span class="b">2</span> Увереннее в сексуальности</td><td class="v">confidence</td></tr>
        <tr><td><span class="b">3</span> Понять какой мужчина нужен</td><td class="v">understand</td></tr>
        <tr><td><span class="b">4</span> Искусство соблазнения</td><td class="v">seduce</td></tr>
        <tr><td><span class="b">5</span> Строить здоровые отношения</td><td class="v">healthy</td></tr>
      </table>
      <div class="qcard-next">-> <strong>Блок 3</strong> (вопрос 3.1)</div>
    </div>


    <!-- ============================================================ -->
    <!-- ========== BLOCK 3: OPENNESS (placeholders) ================ -->
    <!-- ============================================================ -->
    <div class="group-label" style="left:650px; top:2380px; color:var(--orange);">Блок 3: Раскрепощённость (для всех)</div>

    <div class="placeholder-card qcard-orange" id="q31" style="left:200px; top:2440px;">Этап 4 — Вопрос 3.1<br>{style} &middot; баллы 1/2/4/5</div>
    <div class="placeholder-card qcard-orange" id="q32" style="left:600px; top:2440px;">Этап 4 — Вопрос 3.2<br>{oral_attitude} &middot; баллы 1/2/4/5/0</div>
    <div class="placeholder-card qcard-orange" id="q33" style="left:1000px; top:2440px;">Этап 4 — Вопрос 3.3<br>{body_comfort} &middot; баллы 1/2/3/4/5</div>
    <div class="placeholder-card qcard-orange" id="q34" style="left:1400px; top:2440px;">Этап 4 — Вопрос 3.4<br>{toys_exp} &middot; баллы 0/1/3/4/5</div>
    <div class="placeholder-card qcard-orange" id="q35" style="left:1800px; top:2440px;">Этап 4 — Вопрос 3.5<br>{communicate_desires} &middot; баллы 1/2/3/4/5</div>
    <div class="placeholder-card qcard-orange" id="q36" style="left:200px; top:2620px;">Этап 4 — Вопрос 3.6<br>{experiments} &middot; баллы 1/2/3/4/5</div>
    <div class="placeholder-card qcard-orange" id="q37" style="left:600px; top:2620px;">Этап 4 — Вопрос 3.7<br>{her_initiative} &middot; баллы 1/2/3/5</div>
    <div class="placeholder-card qcard-orange" id="q38" style="left:1000px; top:2620px;">Этап 4 — Вопрос 3.8<br>{vocal} &middot; баллы 1/2/4/5</div>
    <div class="placeholder-card qcard-orange" id="q39" style="left:1400px; top:2620px;">Этап 4 — Вопрос 3.9<br>{location} &middot; баллы 1/3/5/5</div>

    <!-- Scoring placeholder -->
    <div class="placeholder-card qcard-orange" id="scoring" style="left:700px; top:2820px; width:700px;">
      Этап 5 — Шкала баллов 0-44<br>
      {total_score} -> {level}: sleeping / awakening / free / fire / goddess
    </div>

    <!-- ========== DECISION 2 ========== -->
    <div class="decision" id="dec2" style="left:920px; top:3000px;">
      <div class="decision-label">Развилка 2 по {status}</div>
      <div class="decision-sub">free -> 4Б -> Результат &middot; !=free -> 4А -> 5 -> Результат</div>
    </div>

    <!-- ========== BLOCK 4A ========== -->
    <div class="group-label" style="left:60px; top:3120px; color:var(--pink);">Блок 4А: Про Него</div>

    <div class="placeholder-card qcard-pink" id="q4a1" style="left:100px; top:3160px;">Этап 4 — Вопрос 4А.1<br>{he_desire}</div>
    <div class="placeholder-card qcard-pink" id="q4a2" style="left:100px; top:3320px;">Этап 4 — Вопрос 4А.2<br>{he_likes}</div>
    <div class="placeholder-card qcard-pink" id="q4a3" style="left:100px; top:3480px;">Этап 4 — Вопрос 4А.3<br>{he_response}<br>-> Блок 5</div>

    <!-- ========== BLOCK 4B ========== -->
    <div class="group-label" style="left:1350px; top:3120px; color:var(--blue);">Блок 4Б: Про Идеал</div>

    <div class="placeholder-card qcard-blue" id="q4b1" style="left:1400px; top:3160px;">Этап 4 — Вопрос 4Б.1<br>{ideal_type}</div>
    <div class="placeholder-card qcard-blue" id="q4b2" style="left:1400px; top:3320px;">Этап 4 — Вопрос 4Б.2<br>{ideal_vibe}</div>
    <div class="placeholder-card qcard-blue" id="q4b3" style="left:1400px; top:3480px;">Этап 4 — Вопрос 4Б.3<br>{ideal_intimacy}<br>-> Результат (блок 5 пропуск)</div>

    <!-- ========== BLOCK 5 ========== -->
    <div class="group-label" style="left:60px; top:3680px; color:var(--pink);">Блок 5: Про Отношения (только в паре)</div>

    <div class="placeholder-card qcard-pink" id="q51" style="left:100px; top:3720px;">Этап 4 — Вопрос 5.1<br>{frequency} &middot; баллы</div>
    <div class="placeholder-card qcard-pink" id="q52" style="left:500px; top:3720px;">Этап 4 — Вопрос 5.2<br>{initiator}</div>
    <div class="placeholder-card qcard-pink" id="q53" style="left:100px; top:3880px;">Этап 4 — Вопрос 5.3<br>{cheating}</div>
    <div class="placeholder-card qcard-pink" id="q54" style="left:500px; top:3880px;">Этап 4 — Вопрос 5.4<br>{main_problem}</div>
    <div class="placeholder-card qcard-pink" id="q55" style="left:300px; top:4040px;">Этап 4 — Вопрос 5.5<br>{change_wish}<br>-> Результат</div>

    <!-- ========== RESULTS ========== -->
    <div class="group-label" style="left:60px; top:4240px; color:var(--green);">Результаты</div>

    <div class="placeholder-card qcard-green" style="left:100px; top:4300px; width:500px;">
      Этап 6 — Рекомендации В ПАРЕ: П1-П15<br>
      15 комбинаций с приоритетом &middot; П15 = fallback
    </div>

    <div class="placeholder-card qcard-green" style="left:1400px; top:4300px; width:500px;">
      Этап 6 — Рекомендации СВОБОДНЫЕ: С1-С15<br>
      15 комбинаций с приоритетом &middot; С15 = fallback
    </div>

    <!-- Variables -->
    <div class="placeholder-card" style="left:700px; top:4550px; width:700px; border-color: var(--green);">
      Этап 7 — Сводная таблица всех переменных
    </div>

  </div>
</div>

<!-- LEGEND -->
<div class="legend">
  <div class="legend-row"><div class="legend-dot" style="background:var(--purple)"></div>Блок 1 — общие</div>
  <div class="legend-row"><div class="legend-dot" style="background:var(--pink)"></div>Ветка «В паре»</div>
  <div class="legend-row"><div class="legend-dot" style="background:var(--blue)"></div>Ветка «Свободна»</div>
  <div class="legend-row"><div class="legend-dot" style="background:var(--orange)"></div>Блок 3 — для всех</div>
  <div class="legend-row"><div class="legend-dot" style="background:var(--green)"></div>Результат</div>
</div>

<!-- MINIMAP -->
<div class="minimap" id="minimap">
  <canvas id="mmCanvas" width="180" height="120"></canvas>
  <div class="minimap-vp" id="mmVp"></div>
</div>

<script>
// === PAN & ZOOM ===
const wrap = document.getElementById('wrap');
const cvs = document.getElementById('canvas');
let sc = 0.45, px = 0, py = 0;
let dragging = false, sx, sy;

function apply() {
  cvs.style.transform = `translate(${px}px,${py}px) scale(${sc})`;
  document.getElementById('zoomLvl').textContent = Math.round(sc*100)+'%';
  updateMM();
}

wrap.addEventListener('mousedown', e => {
  if (e.target.closest('.qcard, .decision, .placeholder-card')) { /* allow text selection */ }
  else { dragging = true; sx = e.clientX - px; sy = e.clientY - py; wrap.classList.add('panning'); e.preventDefault(); }
});
window.addEventListener('mousemove', e => { if (!dragging) return; px = e.clientX - sx; py = e.clientY - sy; apply(); });
window.addEventListener('mouseup', () => { dragging = false; wrap.classList.remove('panning'); });

wrap.addEventListener('wheel', e => {
  e.preventDefault();
  const d = e.deltaY > 0 ? -0.05 : 0.05;
  const ns = Math.min(2, Math.max(0.15, sc + d));
  const r = wrap.getBoundingClientRect();
  const cx = e.clientX - r.left, cy = e.clientY - r.top;
  px = cx - (cx - px) * (ns / sc);
  py = cy - (cy - py) * (ns / sc);
  sc = ns;
  apply();
}, { passive: false });

function zoomBy(d) { sc = Math.min(2, Math.max(0.15, sc + d)); apply(); }
function resetView() { sc = 0.45; px = 0; py = 0; apply(); }
function jumpTo(x, y) {
  const r = wrap.getBoundingClientRect();
  px = r.width/2 - x * sc;
  py = r.height/2 - y * sc;
  apply();
}

// === DRAW ARROWS ===
// Smooth curve using midpoint control points (no tight S-loops)
function line(x1, y1, x2, y2, color, marker) {
  const svg = document.getElementById('svg');
  const p = document.createElementNS('http://www.w3.org/2000/svg','path');
  const my = (y1 + y2) / 2;
  p.setAttribute('d', `M${x1},${y1} C${x1},${my} ${x2},${my} ${x2},${y2}`);
  p.setAttribute('stroke', color);
  p.setAttribute('stroke-width', '2');
  p.setAttribute('fill', 'none');
  p.setAttribute('stroke-opacity', '0.5');
  p.setAttribute('marker-end', `url(#${marker})`);
  svg.appendChild(p);
}

// Horizontal-then-vertical stepped path
function stepLine(x1, y1, x2, y2, color, marker) {
  const svg = document.getElementById('svg');
  const p = document.createElementNS('http://www.w3.org/2000/svg','path');
  const my = (y1 + y2) / 2;
  p.setAttribute('d', `M${x1},${y1} L${x1},${my} L${x2},${my} L${x2},${y2}`);
  p.setAttribute('stroke', color);
  p.setAttribute('stroke-width', '2');
  p.setAttribute('fill', 'none');
  p.setAttribute('stroke-opacity', '0.4');
  p.setAttribute('marker-end', `url(#${marker})`);
  svg.appendChild(p);
}

function getBot(id) { const e=document.getElementById(id); if(!e)return null; return { x:parseInt(e.style.left)+e.offsetWidth/2, y:parseInt(e.style.top)+e.offsetHeight }; }
function getTop(id) { const e=document.getElementById(id); if(!e)return null; return { x:parseInt(e.style.left)+e.offsetWidth/2, y:parseInt(e.style.top) }; }
function getRight(id) { const e=document.getElementById(id); if(!e)return null; return { x:parseInt(e.style.left)+e.offsetWidth, y:parseInt(e.style.top)+e.offsetHeight/2 }; }
function getLeft(id) { const e=document.getElementById(id); if(!e)return null; return { x:parseInt(e.style.left), y:parseInt(e.style.top)+e.offsetHeight/2 }; }

function drawArrows() {
  const svg = document.getElementById('svg');
  svg.querySelectorAll('path').forEach(p=>p.remove());

  // ===== BLOCK 1 =====
  // 1.1 -> 1.1б (left fork)
  const q11b = getBot('q11'), q11bT = getTop('q11b'), q12T = getTop('q12');
  if(q11b && q11bT) line(q11b.x - 60, q11b.y, q11bT.x, q11bT.y, '#6b9dff','ab');
  // 1.1 -> 1.2 (right fork)
  if(q11b && q12T) line(q11b.x + 60, q11b.y, q12T.x, q12T.y, '#ff6b9d','ak');

  // 1.1б -> 1.3
  const q11bb = getBot('q11b'), q13T = getTop('q13');
  if(q11bb && q13T) line(q11bb.x, q11bb.y, q13T.x - 60, q13T.y, '#a06bff','ap');
  // 1.2 -> 1.3
  const q12b = getBot('q12');
  if(q12b && q13T) line(q12b.x, q12b.y, q13T.x + 60, q13T.y, '#a06bff','ap');

  // 1.3 -> Decision 1
  const q13b = getBot('q13'), d1t = getTop('dec1');
  if(q13b && d1t) line(q13b.x, q13b.y, d1t.x, d1t.y, '#a06bff','ap');

  // Decision 1 -> 2A.1, 2B.1
  const d1b = getBot('dec1'), q2a1t = getTop('q2a1'), q2b1t = getTop('q2b1');
  if(d1b && q2a1t) line(d1b.x - 80, d1b.y, q2a1t.x, q2a1t.y, '#ff6b9d','ak');
  if(d1b && q2b1t) line(d1b.x + 80, d1b.y, q2b1t.x, q2b1t.y, '#6b9dff','ab');

  // ===== BLOCK 2A chain =====
  [['q2a1','q2a2'],['q2a2','q2a3']].forEach(([a,b]) => {
    const f=getBot(a), t=getTop(b);
    if(f&&t) line(f.x, f.y, t.x, t.y, '#ff6b9d','ak');
  });

  // ===== BLOCK 2B chains =====
  // Left column: 2B.1 -> 2B.2 -> 2B.3
  [['q2b1','q2b2'],['q2b2','q2b3']].forEach(([a,b]) => {
    const f=getBot(a), t=getTop(b);
    if(f&&t) line(f.x, f.y, t.x, t.y, '#6b9dff','ab');
  });
  // Right column: 2B.4 -> 2B.5 -> 2B.6
  [['q2b4','q2b5'],['q2b5','q2b6']].forEach(([a,b]) => {
    const f=getBot(a), t=getTop(b);
    if(f&&t) line(f.x, f.y, t.x, t.y, '#6b9dff','ab');
  });
  // Cross: 2B.3 -> 2B.4 (step path right->up)
  const b3r = getRight('q2b3'), b4l = getLeft('q2b4');
  if(b3r && b4l) stepLine(b3r.x, b3r.y, b4l.x, b4l.y, '#6b9dff','ab');

  // ===== 2A.3 -> Block 3, 2B.6 -> Block 3 =====
  const q2a3b = getBot('q2a3'), q31t = getTop('q31');
  if(q2a3b && q31t) line(q2a3b.x, q2a3b.y, q31t.x, q31t.y, '#ff6b9d','ak');

  const q2b6b = getBot('q2b6'), q34t = getTop('q34');
  if(q2b6b && q34t) line(q2b6b.x, q2b6b.y, q34t.x, q34t.y, '#6b9dff','ab');

  // ===== Block 3 -> scoring =====
  const q39b = getBot('q39'), sct = getTop('scoring');
  if(q39b && sct) line(q39b.x, q39b.y, sct.x, sct.y, '#ffaa6b','ao');

  // scoring -> decision2
  const scb = getBot('scoring'), d2t = getTop('dec2');
  if(scb && d2t) line(scb.x, scb.y, d2t.x, d2t.y, '#ffaa6b','ao');

  // decision2 -> 4A, 4B
  const d2b = getBot('dec2'), q4a1t = getTop('q4a1'), q4b1t = getTop('q4b1');
  if(d2b && q4a1t) line(d2b.x - 80, d2b.y, q4a1t.x, q4a1t.y, '#ff6b9d','ak');
  if(d2b && q4b1t) line(d2b.x + 80, d2b.y, q4b1t.x, q4b1t.y, '#6b9dff','ab');

  // 4A chain
  [['q4a1','q4a2'],['q4a2','q4a3']].forEach(([a,b])=>{const f=getBot(a),t=getTop(b);if(f&&t)line(f.x,f.y,t.x,t.y,'#ff6b9d','ak');});

  // 4B chain
  [['q4b1','q4b2'],['q4b2','q4b3']].forEach(([a,b])=>{const f=getBot(a),t=getTop(b);if(f&&t)line(f.x,f.y,t.x,t.y,'#6b9dff','ab');});

  // 4A.3 -> 5.1
  const q4a3b=getBot('q4a3'), q51t=getTop('q51');
  if(q4a3b&&q51t) line(q4a3b.x,q4a3b.y,q51t.x,q51t.y,'#ff6b9d','ak');

  // Block 5 chain
  [['q51','q53'],['q52','q54']].forEach(([a,b])=>{const f=getBot(a),t=getTop(b);if(f&&t)line(f.x,f.y,t.x,t.y,'#ff6b9d','ak');});
  const q53b=getBot('q53'),q55t=getTop('q55');
  if(q53b&&q55t) line(q53b.x,q53b.y,q55t.x,q55t.y,'#ff6b9d','ak');
}

// === MINIMAP ===
function updateMM() {
  const mc=document.getElementById('mmCanvas'), ctx=mc.getContext('2d');
  ctx.clearRect(0,0,mc.width,mc.height);
  const bw=2400, bh=5000, s=Math.min(mc.width/bw, mc.height/bh);
  document.querySelectorAll('.qcard,.placeholder-card,.decision').forEach(n=>{
    const x=parseInt(n.style.left)*s, y=parseInt(n.style.top)*s;
    const w=(n.offsetWidth||340)*s, h=(n.offsetHeight||100)*s;
    if(n.classList.contains('qcard-purple')||n.classList.contains('decision')) ctx.fillStyle='#a06bff';
    else if(n.classList.contains('qcard-pink')) ctx.fillStyle='#ff6b9d';
    else if(n.classList.contains('qcard-blue')) ctx.fillStyle='#6b9dff';
    else if(n.classList.contains('qcard-orange')) ctx.fillStyle='#ffaa6b';
    else if(n.classList.contains('qcard-green')) ctx.fillStyle='#6bffb8';
    else ctx.fillStyle='#555';
    ctx.globalAlpha=0.7;
    ctx.fillRect(x,y,Math.max(w,3),Math.max(h,2));
  });
  ctx.globalAlpha=1;
  const vp=document.getElementById('mmVp'), wr=wrap.getBoundingClientRect();
  vp.style.left=(-px/sc)*s+'px'; vp.style.top=(-py/sc)*s+'px';
  vp.style.width=(wr.width/sc)*s+'px'; vp.style.height=(wr.height/sc)*s+'px';
}

// === INIT ===
apply();
requestAnimationFrame(()=>requestAnimationFrame(drawArrows));
</script>

</body>
</html>
